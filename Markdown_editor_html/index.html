<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber-Ace MD Editor</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    
    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-language_tools.js"></script>

    <style>
        :root {
            --cyber-bg-dark: #1a0a2a;
            --cyber-bg-medium: #2a0a3a;
            --cyber-neon-green: #00ff00;
            --cyber-neon-blue: #00ffff;
            --cyber-neon-pink: #ff00ff;
            --cyber-text-light: #e0e0e0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cyber-bg-dark);
            color: var(--cyber-text-light);
            overflow: hidden;
            height: 100vh;
        }

        #editor {
            height: 100%;
            width: 100%;
            border: 2px solid var(--cyber-neon-blue);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            border-radius: 8px;
        }

        #preview-container {
            background-color: var(--cyber-bg-medium);
            border: 2px solid var(--cyber-neon-pink);
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
            overflow-y: hidden;
            position: relative;
            border-radius: 8px;
        }

        #preview-container.maximized {
            overflow-y: auto !important;
        }

        #preview-content {
            position: absolute;
            width: 100%;
            padding: 2rem;
            top: 0;
            left: 0;
            transition: transform 0.1s ease-out;
        }

        #preview-container.maximized #preview-content {
            position: relative;
            transform: none !important;
        }

        #preview-content h1, #preview-content h2, #preview-content h3 {
            color: var(--cyber-neon-blue);
            border-bottom: 1px dashed var(--cyber-neon-pink);
            margin-bottom: 1rem;
            margin-top: 1.5rem;
            font-weight: bold;
        }
        #preview-content h1 { font-size: 1.75rem; }
        #preview-content h2 { font-size: 1.5rem; }
        
        #preview-content code {
            background: rgba(0, 255, 0, 0.1);
            color: var(--cyber-neon-green);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
        }

        #preview-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
        }

        #preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            border: 1px solid var(--cyber-neon-blue);
        }

        #preview-content th {
            background-color: rgba(0, 255, 255, 0.1);
            color: var(--cyber-neon-blue);
            font-weight: bold;
            text-align: left;
            border: 1px solid var(--cyber-neon-blue);
            padding: 0.75rem;
        }

        #preview-content td {
            border: 1px solid rgba(0, 255, 255, 0.3);
            padding: 0.75rem;
            color: var(--cyber-text-light);
        }

        .mermaid {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            justify-content: center;
        }

        .cyber-button {
            background-color: var(--cyber-neon-blue);
            color: var(--cyber-bg-dark);
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        .cyber-button:hover {
            background-color: var(--cyber-neon-pink);
            box-shadow: 0 0 15px var(--cyber-neon-pink);
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--cyber-bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: var(--cyber-neon-green);
            font-size: 1.2rem;
            letter-spacing: 0.2rem;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--cyber-bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--cyber-neon-blue); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--cyber-neon-pink); }
    </style>
</head>
<body class="flex flex-col p-4">

    <div id="loading-overlay">
        <div class="mb-2">SINCRONIZANDO PROTOCOLO DE EXPORTACIÓN...</div>
    </div>

    <header class="flex justify-between items-center mb-4 px-2">
        <h1 class="text-xl font-bold cyber-neon-blue tracking-widest uppercase">Cyber-Ace Protocol v0.02.9</h1>
        <div class="flex gap-4">
            <button id="toggleEditorBtn" class="cyber-button">MAXIMIZAR VISTA</button>
            <button id="downloadBtn" class="cyber-button">EXPORTAR .MD</button>
        </div>
    </header>

    <main class="flex flex-1 gap-4 overflow-hidden">
        <div id="editor-wrapper" class="w-1/2">
            <div id="editor"></div>
        </div>
        <div id="preview-wrapper" class="w-1/2 flex flex-col">
            <div id="preview-container" class="flex-1">
                <div id="preview-content"></div>
            </div>
        </div>
    </main>

    <script>
        window.onload = function() {
            mermaid.initialize({ 
                startOnLoad: false, 
                theme: 'dark', 
                securityLevel: 'loose',
                flowchart: { useMaxWidth: true, htmlLabels: true }
            });

            const editor = ace.edit("editor");
            editor.setTheme("ace/theme/tomorrow_night_eighties");
            editor.session.setMode("ace/mode/markdown");
            
            editor.setOptions({
                fontSize: "16px",
                fontFamily: "'Fira Code', monospace",
                showPrintMargin: false,
                useSoftTabs: true,
                wrap: true,
                enableBasicAutocompletion: true,
                enableLiveAutocompletion: true
            });

            const previewContent = document.getElementById('preview-content');
            const previewContainer = document.getElementById('preview-container');
            const editorWrapper = document.getElementById('editor-wrapper');
            const previewWrapper = document.getElementById('preview-wrapper');
            const toggleBtn = document.getElementById('toggleEditorBtn');

            let mermaidTimeout;
            let isMaximized = false;

            async function updatePreview() {
                const markdown = editor.getValue();
                if (typeof marked !== 'undefined') {
                    let html = marked.parse(markdown);
                    html = DOMPurify.sanitize(html);
                    const temp = document.createElement('div');
                    temp.innerHTML = html;

                    const codeBlocks = temp.querySelectorAll('pre code.language-mermaid');
                    codeBlocks.forEach((block, index) => {
                        const mDiv = document.createElement('div');
                        mDiv.className = 'mermaid';
                        mDiv.id = 'mermaid-graph-' + index;
                        mDiv.textContent = block.textContent.replace(/\u00a0/g, ' '); 
                        block.parentNode.replaceWith(mDiv);
                    });

                    previewContent.innerHTML = temp.innerHTML;

                    clearTimeout(mermaidTimeout);
                    mermaidTimeout = setTimeout(async () => {
                        try {
                            const graphs = document.querySelectorAll('.mermaid');
                            if (graphs.length > 0) {
                                await mermaid.run({ nodes: graphs });
                            }
                        } catch (e) {}
                    }, 250);
                }
            }

            editor.session.on('changeScrollTop', () => {
                if (isMaximized) return;

                const scrollTop = editor.session.getScrollTop();
                const screenHeight = editor.renderer.$size.scrollerHeight;
                const contentHeight = editor.session.getScreenLength() * editor.renderer.lineHeight;
                const maxEditorScroll = contentHeight - screenHeight;
                
                if (maxEditorScroll > 0) {
                    const scrollPercent = scrollTop / maxEditorScroll;
                    const maxPreviewScroll = Math.max(0, previewContent.scrollHeight - previewContainer.clientHeight);
                    previewContent.style.transform = `translateY(-${scrollPercent * maxPreviewScroll}px)`;
                }
            });

            editor.on('change', updatePreview);

            toggleBtn.onclick = () => {
                isMaximized = !isMaximized;
                
                if (isMaximized) {
                    editorWrapper.classList.add('hidden');
                    previewWrapper.classList.replace('w-1/2', 'w-full');
                    previewContainer.classList.add('maximized');
                    toggleBtn.textContent = "MOSTRAR EDITOR";
                } else {
                    editorWrapper.classList.remove('hidden');
                    previewWrapper.classList.replace('w-full', 'w-1/2');
                    previewContainer.classList.remove('maximized');
                    toggleBtn.textContent = "MAXIMIZAR VISTA";
                    editor.renderer.scrollCursorIntoView();
                }
                editor.resize();
            };

            document.getElementById('downloadBtn').onclick = () => {
                const content = editor.getValue();
                
                // Lógica lógica: extrae el primer H1 para nombrar el archivo
                const titleMatch = content.match(/^#\s+(.+)$/m);
                let fileName = "cyber_archive";

                if (titleMatch && titleMatch[1]) {
                    fileName = titleMatch[1]
                        .trim()
                        .toLowerCase()
                        .normalize("NFD")
                        .replace(/[\u0300-\u036f]/g, "") // Quitar acentos
                        .replace(/[^a-z0-9\s-_]/g, '')    // Quitar especiales
                        .replace(/\s+/g, '_');           // Espacios a guiones
                }

                const blob = new Blob([content], {type: 'text/markdown'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileName}.md`;
                a.click();
                setTimeout(() => URL.revokeObjectURL(url), 100);
            };

            const initialValue = `# Editor Amigable de Markdown

## Instrucciones
Al pulsar **MAXIMIZAR VISTA**, ahora puedes usar el scroll de tu ratón o teclado para leer todo el documento de forma fluida.

El nombre del archivo exportado se adaptará automáticamente al primer título que escribas abajo.

| Función | Estado |
| :--- | :--- |
| Scroll Sincronizado | Solo en modo Split |
| Navegación Manual | En modo Maximize |

## Diagrama de Mermaid
\`\`\`mermaid
graph TD;
    subgraph Conceptos_Centrales
        A((Materia Vibrante));
        B(Vitalidad);
        C(Agencia);
    end

    subgraph Fundamentos_y_Proyecto
        D{Definicion};
        E{Proyecto Politico};
    end

    subgraph Conceptos_Clave
        F(Ensamblaje o Agenciamiento);
        G(Causalidad Emergente);
        H(Cuerpos Confederados);
    end

    A -- posee --> B;
    B -- fundamenta la --> C;
    
    D -- es un --> D1[Principio Activo];
    D -- es una --> D2[Materialidad Viva];
    D -- no necesita --> D3[Intencionalidad o Divinidad];
    
    E -- busca --> E1[Interacciones Sustentables];
    E -- busca --> E2[Cambiar Respuestas Politicas];

    C -- se manifiesta como --> C1[Agencia Distributiva];
    C1 -- es un --> C2[Enjambre de Vitalidades];
    C1 -- se opone a --> C3[Agencia localizada en el sujeto];

    F -- se compone de --> F1[Elementos Diversos];
    F -- se caracteriza por --> F2[Propiedades Emergentes];
    F -- se caracteriza por --> F3[Poder Irregular];
    F -- se caracteriza por --> F4[Sin Cabeza Central];
    F -- es un --> F5[Colectivo Abierto y Finito];
    F2 -- genera la --> F2a[Agencia del Ensamblaje];

    G -- es --> G1[Fractal y en Circuitos];
    G -- se opone a --> G2[Causalidad Lineal y Eficiente];

    H -- concepto de --> H1[Spinoza];
    H -- explica como --> H2[Cuerpos se asocian];
    H2 -- para --> H3[Incrementar su Potencia];

    classDef central fill:#f9f,stroke:#333,stroke-width:2px;
    classDef clave fill:#ccf,stroke:#333,stroke-width:2px;
    class A,B,C central;
    class F,G,H clave;
\`\`\`
## Prueba texto tipo código (python)
\`\`\`python
print("Hola mundo!")
\`\`\`

${Array(20).fill("Contenido de relleno para probar el scroll...").join("\n\n")}`;

            editor.setValue(initialValue, -1);
            updatePreview();
            
            const overlay = document.getElementById('loading-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 300);
        };
    </script>
</body>
</html>


